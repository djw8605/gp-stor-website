---
// src/components/NextOfficeHours.astro

// Generate a unique ID for this specific instance of the component.
// This ensures that if you use the component multiple times on a page,
// the script targets the correct HTML element.
const uniqueId = `next-office-hours-${crypto.randomUUID().slice(0, 8)}`;

// You could add component props here if needed, e.g., to customize the display format
// export interface Props { /* ... */ }
// const { ... } = Astro.props;
---

{/* The HTML part of the component. It gets the unique ID. */}
<span id={uniqueId}>Loading next office hours...</span>

{/* The client-side script. 
  - `define:vars` passes the uniqueId from the server-side frontmatter to the client script.
  - The script now targets the element using the specific `elementId`.
  - The event listener ensures it re-runs and finds the correct element after page transitions.
*/}
<script define:vars={{ elementId: uniqueId }}>
  function calculateAndDisplayNextOfficeHours(targetElementId) {
    // Find the specific element instance using the unique ID
    const targetElement = document.getElementById(targetElementId);
    
    // Important: Check if the element exists. During Astro's page transitions,
    // the script might run before the *new* element is fully ready, or the
    // old one might already be gone.
    if (!targetElement) {
      // console.warn(`NextOfficeHours component target (ID: ${targetElementId}) not found during update.`);
      return; // Exit gracefully if the element isn't found
    }

    const MS_PER_WEEK = 1000 * 60 * 60 * 24 * 7;
    // IMPORTANT: Month is 0-indexed in Date.UTC/Date, so 4 = May
    // const knownOfficeStartUTC = Date.UTC(2025, 5, 2, 17); // May 12, 2025 at 10am PDT == 17:00 UTC
    const knownOfficeStartUTC = Date.UTC(2025, 4, 6, 18);

    const nowUTC = Date.now();
    let nextOfficeUTC = knownOfficeStartUTC;

    // Loop until we find the next office hours start time that is
    // not more than 30 minutes in the past.
    while (nextOfficeUTC <= nowUTC - 30 * 60 * 1000) {
      nextOfficeUTC += 2 * MS_PER_WEEK; // Add two weeks
    }

    const nextOffice = new Date(nextOfficeUTC);
    // Format the date/time for display
    const formatted = nextOffice.toLocaleString("en-US", {
      weekday: "long",
      month: "long",
      day: "numeric",
      year: "numeric",
      hour: "numeric",
      minute: "2-digit",
      timeZone: "America/Los_Angeles", // Display in Pacific Time
      timeZoneName: "short",
    });

    // Update the specific element's text content
    targetElement.textContent = formatted;
  }

  // --- Astro Integration ---
  
  // Run the function for the initial render of this component instance
  // Pass the unique elementId received from define:vars
  calculateAndDisplayNextOfficeHours(elementId); 

  // Add an event listener to run the function after Astro's page transitions.
  // The listener will call the function again, ensuring the specific element
  // identified by elementId is updated on the *new* page content.
  document.addEventListener('astro:page-load', () => {
    calculateAndDisplayNextOfficeHours(elementId);
  });
</script>